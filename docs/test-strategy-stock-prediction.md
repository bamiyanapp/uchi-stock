# 日用品在庫管理アプリ テスト戦略（在庫予測詳細）

## 1. 目的

本テスト戦略は、日用品在庫管理アプリにおける
**在庫予測（残り在庫数・無くなる日）** の正確性・一貫性・説明可能性を担保することを目的とする。

特に以下を重視する。

- ユーザー入力が不完全・散発的な場合でも破綻しないこと
- 時系列ロジックを「待たずに」検証可能であること
- 予測精度と信頼度がデータ量に応じて適切に変化すること

---

## 2. 対象機能

- 品目在庫の登録・更新
- 消費履歴・補充履歴の記録
- 平均消費量の算出・管理
- 残り在庫数の算出
- 在庫が無くなる日の予測
- 予測信頼度の算出

---

## 3. 前提データ構造

### household-items テーブル

- currentStock
- averageConsumptionPerDay
- averageConsumptionSource
  - provisional（仮置き）
  - calculated（履歴計算）
  - userDefined（ユーザー入力）

### stock-history テーブル

- type: purchase / consumption
- date（ISO8601）
- quantity

---

## 4. 基本テスト方針

### 4.1 時系列テストの考え方

- 実時間の経過を待つテストは行わない
- **日付を逆算したテストデータを投入** し、即時に結果を検証する
- テスト実行時の日付を基準日（T0）とし、すべて相対日付で管理する

例：
- T0 - 10日
- T0 - 3日
- T0

---

### 4.2 検証の中心観点

| 観点 | 説明 |
|---|---|
| 在庫乖離 | 計算在庫と期待在庫の差 |
| 日付乖離 | 予測日と期待日の差 |
| 許容誤差 | 変動消費における±日数 |
| 信頼度 | データ量・鮮度に応じた妥当性 |

---

## 5. 平均消費量に関する戦略

### 5.1 初期状態（履歴なし）

- 平均消費量は **provisional（仮置き）** とする
- 仮置き値はカテゴリベースまたはシステム定義値
- 信頼度は「低」

### 5.2 履歴取得後

- 一定件数・一定期間を超えたら calculated に移行
- 実測データに基づき平均消費量を再計算
- 信頼度を段階的に引き上げる

---

## 6. テスト観点の整理軸

### 6.1 在庫状態軸

- 在庫あり（多い）
- 在庫あり（少ない）
- 在庫なし
- 在庫入力なし（実在庫なし）

### 6.2 消費パターン軸

- 単純消費（固定）
- 変動消費（平均）
- 消費ゼロ
- 消費停止（入力なし）

### 6.3 補充パターン軸

- 補充なし
- 1回補充
- 複数回補充
- 在庫ゼロ時の補充

### 6.4 ユーザー行動軸

- マメに入力する
- 散発的に入力する
- 長期間入力なし

---

## 7. 代表テストケース（抜粋）

### 7.1 基本ケース

| ケース | 在庫 | 消費/日 | 補充 | 期待結果 |
|---|---|---|---|---|
| 単純消費 | 10 | 1 | なし | 10日後 |
| 在庫少 | 3 | 1 | なし | 3日後 |

---

### 7.2 消費変動ケース

| ケース | 在庫 | 消費 | 補充 | 許容 |
|---|---|---|---|---|
| 平均消費 | 10 | 平均1 | なし | ±1日 |

---

### 7.3 補充ありケース

| ケース | 在庫 | 消費/日 | 補充 | 期待 |
|---|---|---|---|---|
| 途中補充 | 5 | 1 | 3日後 +10 | 18日後 |
| 複数補充 | 0 | 1 | 2回 | 補充後から再計算 |

---

### 7.4 特殊ケース

| ケース | 内容 | 期待 |
|---|---|---|
| 消費ゼロ | consumption=0 | 無限 or 未定 |
| 入力停止 | 最終入力から長期間 | 消費低下 or 信頼度低下 |
| 初期状態 | 履歴なし | provisional + 低信頼 |

---

## 8. 信頼度テスト方針

| 状態 | 履歴件数 | source | 信頼度 |
|---|---|---|---|
| 初期 | 0 | provisional | 低 |
| 移行期 | 1〜2 | calculated | 中 |
| 定常 | 3以上 | calculated | 高 |

---

## 9. テストデータ生成方針

- テスト実行時の日付を基準に相対日付で生成
- デプロイごとに自動生成可能なデータセットを用意
- 同一ロジックで CI 上でも再現可能とする

---

## 10. まとめ

- 在庫予測は「常に最新」ではなく「説明可能」であることを重視
- 仮置き・実測・信頼度を明確に区別する
- 時系列はデータ設計でテスト可能にする
- ユーザー行動のばらつきを前提としたテスト設計を行う
