# テスト戦略

## 概要

本プロジェクトでは、品質を確保し、バグを早期に発見するための包括的なテスト戦略を採用しています。テストは、ユニットテスト、インテグレーションテスト、エンドツーエンド（E2E）テストの階層構造で構成され、各層で異なる側面をカバーします。

## テストピラミッド

```
     E2Eテスト (少量)
   インテグレーションテスト (中量)
ユニットテスト (大量)
```

### ユニットテスト
- **目的**: 個々の関数やコンポーネントのロジックを検証
- **フレームワーク**: Vitest
- **対象**: 純粋関数、ビジネスロジック、UIコンポーネントのロジック部分
- **特徴**:
  - 高速実行
  - 外部依存をモック化（DynamoDB, fetch, etc.）
  - 成功ケース、失敗ケース、エラーケースを網羅

### インテグレーションテスト
- **目的**: 複数のコンポーネントやモジュール間の連携を検証
- **フレームワーク**: Vitest + @testing-library/react
- **対象**: API統合、コンポーネント間通信、データフロー
- **特徴**:
  - 実際の依存関係を使用（可能な場合）
  - 外部APIのモック化
  - ユーザーインタラクションのシミュレーション

### E2Eテスト
- **目的**: 実際のユーザー体験をエンドツーエンドで検証
- **フレームワーク**: Playwright（計画中）
- **対象**: ログインから在庫管理までの完全なフロー
- **特徴**:
  - ブラウザでの実際の操作
  - 遅いが最も信頼性が高い
  - CI/CDで自動実行

## 現状の実装

### Backend (Node.js + AWS Lambda)

**テストファイル**: `backend/handler.test.js`
- **フレームワーク**: Vitest
- **テスト対象**: APIハンドラー関数
- **テスト観点**:
  - 正常系: アイテム作成、取得、更新、削除、在庫追加・消費、履歴取得、推定日計算
  - 異常系: 必須パラメータ欠如、無効なデータ、DynamoDBエラー
  - ユーザー分離: ヘッダー `x-user-id` によるユーザー固有データ検証
  - モック: DynamoDB DocumentClient のモック化
  - 日時固定: Vitest の fake timers でテスト安定化

**カバレッジ**:
- 各APIエンドポイントの基本機能
- エラーハンドリング
- ユーザー権限の検証

### Frontend (React)

**テストファイル**:
- `frontend/src/App.test.jsx`
- `frontend/src/components/ItemDetail.test.jsx`
- `frontend/src/contexts/UserContext.test.jsx`

- **フレームワーク**: Vitest + @testing-library/react
- **テスト対象**: Reactコンポーネント、Context
- **テスト観点**:
  - コンポーネントレンダリング: 正しい要素表示、データバインディング
  - ユーザーインタラクション: クリック、フォーム入力、ナビゲーション
  - データ取得: APIレスポンスの処理、エラーハンドリング
  - 認証: ログイン状態の管理、デフォルトユーザー対応
  - モック: fetch API, Recharts, Lucide icons, AWS Amplify Auth
  - 非同期処理: loading状態、エラー状態の表示

**カバレッジ**:
- 主要コンポーネントのレンダリング
- 画面遷移とフォーム操作
- API統合時のエラーハンドリング
- 認証Contextの状態管理

## テスト実行

### ローカル実行

```bash
# Backendテスト
cd backend
npm test

# Frontendテスト
cd frontend
npm test

# 全体テスト（ルートから）
npm test
```

### CI/CD実行

GitHub Actions で以下のテストが自動実行されます：
- ユニットテスト
- リンター（ESLint）
- ビルド確認

### カバレッジレポート

テスト実行時にカバレッジレポートが生成されます。目標カバレッジ：
- ユニットテスト: 80%以上
- 主要コンポーネント: 90%以上

## 品質基準

### テスト合格条件
- **lint errors**: 0
- **test failures**: 0
- **build failures**: 0

### コードレビューポイント
- 要件との整合性: テストが仕様を正しくカバーしているか
- 潜在バグ: エッジケース、境界値テストの不足
- テスト不足: 重要な機能のテスト漏れ
- 可読性・命名: テストコードの明瞭さ
- 将来の変更耐性: テストの保守性
- セキュリティ懸念: 認証・認可のテスト

### 継続的改善
- 新機能追加時は必ずテストを追加
- リファクタリング時はテストを更新
- カバレッジ低下時は原因を調査・改善
- パフォーマンステストの導入検討（将来）

## テストデータの管理

### テストデータ戦略
- **固定データ**: テストの安定性確保のため、日時・ID等を固定
- **モックデータ**: 外部依存を排除し、テストを高速化
- **環境分離**: テスト環境と本番環境を明確に分離

### データ生成
- UUID: `crypto.randomUUID()` をモック化
- 日時: Vitest fake timers で固定
- ユーザーID: テスト用固定値を使用

## 将来の拡張計画

- E2Eテストの導入（Playwright）
- ビジュアル回帰テスト
- パフォーマンステスト
- アクセシビリティテスト
- セキュリティテストの強化

## 参考資料

- [Vitest公式ドキュメント](https://vitest.dev/)
- [Testing Library公式ドキュメント](https://testing-library.com/)
- [テスト駆動開発（TDD）ベストプラクティス](https://martinfowler.com/bliki/TestDrivenDevelopment.html)
