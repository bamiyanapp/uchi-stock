# テスト戦略

## 概要

本プロジェクトでは、品質を確保し、バグを早期に発見するための包括的なテスト戦略を採用しています。テストは、ユニットテスト、インテグレーションテスト、エンドツーエンド（E2E）テストの階層構造で構成され、各層で異なる側面をカバーします。

## テストピラミッド

```
     E2Eテスト (少量)
   インテグレーションテスト (中量)
ユニットテスト (大量)
```

### ユニットテスト
- **目的**: 個々の関数やコンポーネントのロジックを検証
- **フレームワーク**: Vitest
- **対象**: 純粋関数、ビジネスロジック、UIコンポーネントのロジック部分
- **特徴**:
  - 高速実行
  - 外部依存をモック化（DynamoDB, fetch, etc.）
  - 成功ケース、失敗ケース、エラーケースを網羅

### インテグレーションテスト
- **目的**: 複数のコンポーネントやモジュール間の連携を検証
- **フレームワーク**: Vitest + @testing-library/react
- **対象**: API統合、コンポーネント間通信、データフロー
- **特徴**:
  - 実際の依存関係を使用（可能な場合）
  - 外部APIのモック化
  - ユーザーインタラクションのシミュレーション

### E2Eテスト
- **目的**: 実際のユーザー体験をエンドツーエンドで検証
- **フレームワーク**: Playwright
- **対象**: 画面遷移、在庫更新、履歴表示などの主要フロー
- **特徴**:
  - ブラウザ（Chromium）での実際の操作
  - APIをモック化することで安定したテスト実行を実現
  - CI/CDでの自動実行が可能

## 現状の実装

### Backend (Node.js + AWS Lambda)

**テストファイル**: `backend/handler.test.js`
- **フレームワーク**: Vitest
- **テスト対象**: APIハンドラー関数
- **テスト観点**:
  - 正常系: アイテム作成、取得、更新、削除、在庫追加・消費、履歴取得、推定日計算
  - 異常系: 必須パラメータ欠如、無効なデータ、DynamoDBエラー
  - ユーザー分離: ヘッダー `x-user-id` によるユーザー固有データ検証
  - モック: DynamoDB DocumentClient のモック化
  - 日時固定: Vitest の fake timers でテスト安定化

**カバレッジ**:
- 各APIエンドポイントの基本機能
- エラーハンドリング
- ユーザー権限の検証

### Frontend (React)

**ユニット・インテグレーションテスト**:
- `frontend/src/App.test.jsx`
- `frontend/src/components/ItemDetail.test.jsx`
- `frontend/src/contexts/UserContext.test.jsx`

- **フレームワーク**: Vitest + @testing-library/react
- **テスト対象**: Reactコンポーネント、Context
- **テスト観点**:
  - コンポーネントレンダリング: 正しい要素表示、データバインディング
  - ユーザーインタラクション: クリック、フォーム入力、ナビゲーション
  - データ取得: APIレスポンスの処理、エラーハンドリング
  - 認証: ログイン状態の管理、デフォルトユーザー対応
  - モック: fetch API, Recharts, Lucide icons, AWS Amplify Auth
  - 非同期処理: loading状態、エラー状態の表示

**カバレッジ**:
- 主要コンポーネントのレンダリング
- 画面遷移とフォーム操作
- API統合時のエラーハンドリング
- 認証Contextの状態管理

### E2Eテスト (Playwright)

**テストファイル**:
- `frontend/e2e/home.spec.js`: 在庫一覧画面のテスト
- `frontend/e2e/item-detail.spec.js`: 在庫詳細・履歴画面のテスト
- `frontend/e2e/stock-update.spec.js`: 在庫更新画面のテスト

- **フレームワーク**: Playwright
- **テスト対象**: 各画面の主要な表示とインタラクション
- **テスト観点**:
  - Home: アイテムリストの表示、在庫切れ予想の表示
  - ItemDetail: 詳細情報の表示、在庫推移グラフの表示、履歴一覧の表示
  - StockUpdate: 在庫更新フォームの入力、バリデーション、送信後の遷移
- **モック戦略**: Playwrightの `page.route` を使用してAPIレスポンスをモック化し、バックエンドに依存せずテストを完結させています。

## テスト実行

### ローカル実行

```bash
# Backendテスト
cd backend
npm test

# Frontendテスト (Unit/Integration)
cd frontend
npm test

# Frontendテスト (E2E)
cd frontend
npm run test:e2e

# 全体テスト（ルートから）
npm test
```

### CI/CD実行

GitHub Actions で以下のテストが自動実行されます：
- ユニットテスト
- リンター（ESLint）
- ビルド確認

### カバレッジレポート

テスト実行時にカバレッジレポートが生成されます。目標カバレッジ：
- ユニットテスト: 80%以上
- 主要コンポーネント: 90%以上

## 品質基準

### テスト合格条件
- **lint errors**: 0
- **test failures**: 0
- **build failures**: 0

### コードレビューポイント
- 要件との整合性: テストが仕様を正しくカバーしているか
- 潜在バグ: エッジケース、境界値テストの不足
- テスト不足: 重要な機能のテスト漏れ
- 可読性・命名: テストコードの明瞭さ
- 将来の変更耐性: テストの保守性
- セキュリティ懸念: 認証・認可のテスト

### 継続的改善
- 新機能追加時は必ずテストを追加
- リファクタリング時はテストを更新
- カバレッジ低下時は原因を調査・改善
- パフォーマンステストの導入検討（将来）

## テストデータの管理

### テストデータ戦略
- **固定データ**: テストの安定性確保のため、日時・ID等を固定
- **モックデータ**: 外部依存を排除し、テストを高速化
- **環境分離**: テスト環境と本番環境を明確に分離

### データ生成
- UUID: `crypto.randomUUID()` をモック化
- 日時: Vitest fake timers で固定
- ユーザーID: テスト用固定値を使用

## 在庫予測テスト戦略

在庫予測機能（残り在庫数・無くなる日の予測）に関しては、時系列データとユーザー行動のばらつきを考慮した特別なテスト戦略を採用しています。

### 戦略概要
- **目的**: 在庫予測の正確性・一貫性・説明可能性を担保
- **重点**: 不完全入力時でも破綻せず、データ量に応じた信頼度変化
- **手法**: 実時間経過を待たず、日付逆算テストデータで検証
- **対象**: 消費履歴、補充履歴、平均消費量算出、信頼度管理

### 詳細戦略
戦術レベルの詳細（テストケース、データ生成、観点整理軸など）は [test-strategy-stock-prediction.md](test-strategy-stock-prediction.md) を参照してください。

## 将来の拡張計画

- ビジュアル回帰テスト
- パフォーマンステスト
- アクセシビリティテスト
- セキュリティテストの強化

## 参考資料

- [Vitest公式ドキュメント](https://vitest.dev/)
- [Testing Library公式ドキュメント](https://testing-library.com/)
- [テスト駆動開発（TDD）ベストプラクティス](https://martinfowler.com/bliki/TestDrivenDevelopment.html)
