'use strict';

var clientPolly = require('@aws-sdk/client-polly');
var utilFormatUrl = require('@aws-sdk/util-format-url');
var protocolHttp = require('@smithy/protocol-http');
var signatureV4 = require('@smithy/signature-v4');

const getSignedUrl = async (client, command, options = {}) => {
    const { credentials } = client.config;
    const signer = new signatureV4.SignatureV4({
        service: options.service || "polly",
        uriEscapePath: options.uriEscapePath || false,
        ...client.config,
        credentials: credentials,
    });
    const presignInterceptMiddleware = (next, context) => async (args) => {
        const { request } = args;
        if (!protocolHttp.HttpRequest.isInstance(request)) {
            throw new Error("Request to be presigned is not an valid HTTP request.");
        }
        request.method = "GET";
        delete request.headers["amz-sdk-invocation-id"];
        delete request.headers["amz-sdk-request"];
        delete request.headers["content-length"];
        request.body = "";
        request.query = {
            ...request.query,
            ...args.input,
        };
        const unsignableHeaders = new Set();
        unsignableHeaders.add("content-type");
        const presigned = await signer.presign(request, {
            expiresIn: 3600,
            unsignableHeaders,
            ...options,
            signingRegion: options.signingRegion ?? context["signing_region"],
            signingService: options.signingService ?? context["signing_service"],
        });
        return {
            response: {},
            output: {
                $metadata: { httpStatusCode: 200 },
                presigned,
            },
        };
    };
    client.middlewareStack.addRelativeTo(presignInterceptMiddleware, {
        name: "presignInterceptMiddleware",
        relation: "before",
        toMiddleware: "awsAuthMiddleware",
        override: true,
    });
    let presigned;
    try {
        const output = await client.send(command);
        presigned = output.presigned;
    }
    finally {
        client.middlewareStack.remove("presignInterceptMiddleware");
    }
    return utilFormatUrl.formatUrl(presigned);
};

const getSynthesizeSpeechUrl = async (input) => {
    const command = new clientPolly.SynthesizeSpeechCommand(input.params);
    const options = input.options || {};
    return await getSignedUrl(input.client, command, options);
};

exports.getSynthesizeSpeechUrl = getSynthesizeSpeechUrl;
