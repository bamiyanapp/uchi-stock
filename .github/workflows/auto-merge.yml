name: Auto Merge
run-name: Auto Merge ${{ github.event.workflow_run.head_commit.message }}

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  merge:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prs = context.payload.workflow_run.pull_requests;
            console.log('PRs found in workflow_run:', JSON.stringify(prs, null, 2));
            if (!prs.length) {
              console.log('No PRs associated with this workflow_run.');
              return;
            }
            const prNumber = prs[0].number;
            console.log(`Attempting to merge PR #${prNumber}`);
            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: "squash"
              });
              console.log(`Successfully merged PR #${prNumber}`);

              // Delete the branch after successful merge
              const pr = prs[0];
              const branchName = pr.head.ref;
              console.log(`Attempting to delete branch: ${branchName}`);
              await github.rest.git.deleteRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `heads/${branchName}`
              });
              console.log(`Successfully deleted branch: ${branchName}`);
            } catch (error) {
              console.error(`Failed to merge PR #${prNumber}:`, error.message);
              throw error;
            }
