name: CD
run-name: CD ${{ github.event.head_commit.message }}

on:
  push:
    branches:
      - release
permissions:
  contents: write
  issues: write
  pull-requests: write
  pages: write
  id-token: write

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: release
          fetch-depth: 0
          token: ${{ secrets.BOT_TOKEN != '' && secrets.BOT_TOKEN || secrets.GITHUB_TOKEN }}
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          cache: "npm"
      - name: Install dependencies
        run: npm ci

      # „Éá„Éê„ÉÉ„Ç∞: Release „Éñ„É©„É≥„ÉÅ„ÅÆÊÉÖÂ†±„ÇíÂá∫Âäõ
      - name: Debug Release branch
        run: |
          echo "===== RELEASE BRANCH ====="
          echo "Branch: $(git branch --show-current)"
          echo "Commit: $(git rev-parse HEAD)"
          echo "Tags containing HEAD:"
          git tag --contains HEAD
          echo "All tags:"
          git fetch --tags origin
          git tag -l
    
      # „Éá„Éê„ÉÉ„Ç∞: Main „Éñ„É©„É≥„ÉÅ„ÅÆÊÉÖÂ†±„ÇÇÁ¢∫Ë™ç
      - name: Debug Main branch
        run: |
          echo "===== MAIN BRANCH ====="
          git fetch origin main --depth=1
          git checkout origin/main
          echo "Branch: $(git branch --show-current)"
          echo "Commit: $(git rev-parse HEAD)"
          echo "Tags containing HEAD:"
          git tag --contains HEAD
          echo "All tags:"
          git fetch --tags origin
          git tag -l
          # Release „Éñ„É©„É≥„ÉÅ„Å´Êàª„Åô
          git checkout release
      
      - name: Check for tag conflicts
        id: check-tags
        env:
          GITHUB_TOKEN: ${{ secrets.BOT_TOKEN != '' && secrets.BOT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          # semantic-release „Åå‰ªò„Åë„Çã‰∫àÂÆö„ÅÆÊ¨°„Éê„Éº„Ç∏„Éß„É≥„ÇíÁ¢∫Ë™ç
          NEXT_TAG=$(npx semantic-release --dry-run | grep "The next release version is" | awk '{print $6}')
          echo "NEXT_TAG=$NEXT_TAG" >> $GITHUB_ENV
          # Êó¢Â≠ò„Çø„Ç∞„Å®ÈáçË§á„Åó„Å¶„ÅÑ„Å™„ÅÑ„ÅãÁ¢∫Ë™ç
          if git rev-parse "refs/tags/$NEXT_TAG" >/dev/null 2>&1; then
            echo "Tag $NEXT_TAG already exists. Exiting."
            exit 0
          fi
          git fetch --tags origin
          git tag --contains HEAD

      # ‚ö† „Çø„Ç∞Êï¥Âêà„ÉÅ„Çß„ÉÉ„ÇØ„Çπ„ÉÜ„ÉÉ„Éó„ÇíËøΩÂä†
      - name: Check Release vs Main tag alignment
        run: |
          echo "===== TAG ALIGNMENT CHECK ====="
          git fetch origin main --depth=1
          RELEASE_LATEST=$(git describe --tags --abbrev=0 HEAD)
          MAIN_LATEST=$(git describe --tags --abbrev=0 origin/main)
          echo "Latest Release tag: $RELEASE_LATEST"
          echo "Latest Main tag:    $MAIN_LATEST"
    
          if [ "$RELEASE_LATEST" != "$MAIN_LATEST" ]; then
            echo "‚ö† WARNING: Release and Main tags are out of sync!"
            echo "Please make sure Main has the latest tags before creating PR."
          else
            echo "Release and Main tags are in sync ‚úÖ"
          fi

      - name: Semantic Release
        env:
          GITHUB_TOKEN: ${{ secrets.BOT_TOKEN != '' && secrets.BOT_TOKEN || secrets.GITHUB_TOKEN }}
          # DEBUG: semantic-release:*
        run: |
          npx semantic-release
      - name: Create PR from release to main
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: main
          head: release
          title: "Sync release branch into main"
          body: "Automated PR to sync release changes into main."
          draft: false
          commit-message: "chore: sync release branch into main"

  build-and-deploy-frontend:
    needs: release
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: release # Checkout the release branch for deployment
          fetch-depth: 0
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      - name: Install dependencies
        working-directory: frontend
        run: npm ci
      - name: Build
        working-directory: frontend
        run: npm run build
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: frontend/dist
      - name: üöÄ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      - name: Show GitHub Pages URL
        run: |
          echo "Pages URL: ${{ steps.deployment.outputs.page_url }}"

  deploy-backend:
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: release # Checkout the release branch for deployment
          fetch-depth: 0
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      - name: Install dependencies
        working-directory: backend
        run: npm ci
      - name: üöÄ Deploy Backend (Serverless Framework)
        working-directory: backend
        run: npx serverless deploy
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      - name: üå± Seed Database
        working-directory: backend
        run: node seed.js
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
