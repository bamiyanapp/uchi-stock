name: CD
run-name: CD ${{ github.event.workflow_run.head_sha }}

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  issues: write
  pull-requests: write
  pages: write
  id-token: write

jobs:
  release:
    if: github.ref == 'refs/heads/main'
    name: Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.BOT_TOKEN || secrets.GITHUB_TOKEN }}
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          cache: "npm"
      - name: Install dependencies
        run: npm ci
      - name: Debug git state
        run: |
          git status -sb
          git log --oneline -5
          git tag --sort=-v:refname | head -5
      - name: Handle tag conflict
        run: |
          git fetch --tags --force
          # ÊúÄÊñ∞„ÅÆ„Çø„Ç∞„ÅåÁèæÂú®„ÅÆHEAD„ÅÆÂ±•Ê≠¥„Å´Âê´„Åæ„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÄÅ
          # semantic-release „Åå„Çø„Ç∞„ÅÆÈáçË§á„Ç®„É©„Éº„ÅßÂ§±Êïó„Åô„Çã„ÅÆ„ÇíÈò≤„Åê„Åü„ÇÅ„ÄÅ
          # fake merge (-s ours) „ÇíË°å„ÅÑÂ±•Ê≠¥„ÇíÁπã„Åí„Çã„ÄÇ
          LATEST_TAG=$(git tag --sort=-v:refname | head -n 1)
          if [ -n "$LATEST_TAG" ]; then
            if ! git merge-base --is-ancestor "$LATEST_TAG" HEAD; then
              echo "Warning: $LATEST_TAG is not an ancestor of HEAD. Performing a fake merge to ensure continuity."
              git config user.name "github-actions"
              git config user.email "github-actions@github.com"
              git merge -s ours "$LATEST_TAG" --no-edit || echo "Merge failed, but proceeding..."
            fi
          fi
      - name: Semantic Release
        env:
          GITHUB_TOKEN: ${{ secrets.BOT_TOKEN || secrets.GITHUB_TOKEN }}
          DEBUG: semantic-release:*
        run: npx semantic-release

  changelog:
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout release branch
        uses: actions/checkout@v4
        with:
          ref: release
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: Install dependencies
        run: npm ci
      # ÂÖ®„Çø„Ç∞„Åã„Çâ CHANGELOG ÂÜçÁîüÊàê
      - name: Generate full CHANGELOG
        run: |
          npx conventional-changelog \
            -p conventionalcommits \
            -i CHANGELOG.md \
            -s \
            -r 0
      # JSON Â§âÊèõÔºà‰ªªÊÑèÔºâ
      - name: Convert changelog to JSON
        run: node scripts/convert-changelog-to-json.js
      - name: Commit & push to release
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add CHANGELOG.md frontend/src/changelog.json
          git commit -m "docs(changelog): ${{ github.ref_name }}" || exit 0
          git push origin release

  build-and-deploy-frontend:
    needs: release
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: release # Checkout the release branch for deployment
          fetch-depth: 0
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      - name: Install dependencies
        working-directory: frontend
        run: npm ci
      - name: Build
        working-directory: frontend
        run: npm run build
        env:
          VITE_USER_POOL_ID: ${{ secrets.VITE_USER_POOL_ID }}
          VITE_USER_POOL_CLIENT_ID: ${{ secrets.VITE_USER_POOL_CLIENT_ID }}
          VITE_AUTH_DOMAIN: ${{ secrets.VITE_AUTH_DOMAIN }}
          VITE_REDIRECT_SIGN_IN: ${{ secrets.VITE_REDIRECT_SIGN_IN }}
          VITE_REDIRECT_SIGN_OUT: ${{ secrets.VITE_REDIRECT_SIGN_OUT }}
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: frontend/dist
      - name: üöÄ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      - name: Show GitHub Pages URL
        run: |
          echo "Pages URL: ${{ steps.deployment.outputs.page_url }}"

  deploy-backend:
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: release # Checkout the release branch for deployment
          fetch-depth: 0
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - name: Install Root dependencies
        run: npm ci
      - name: Install Backend dependencies
        working-directory: backend
        run: npm ci
      - name: üõ°Ô∏è Check for Destructive Changes
        run: node scripts/check-destructive-changes.js
        env:
          FORCE_DEPLOY: ${{ github.event.inputs.force_deploy || 'false' }}
      - name: üíæ Backup DynamoDB
        run: |
          cd backend
          TABLE_NAMES=$(npx serverless print --format json | jq -r '.resources.Resources[] | select(.Type=="AWS::DynamoDB::Table") | .Properties.TableName')
          cd ..
          node scripts/backup-dynamodb.js $TABLE_NAMES
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ap-northeast-1
      - name: üöÄ Deploy Backend (Serverless Framework)
        working-directory: backend
        run: npx serverless deploy
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      - name: üå± Seed Database
        working-directory: backend
        run: node seed.js
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      - name: üß™ Seed Test Data for Stock Prediction
        working-directory: backend
        run: node seed-test-stock-prediction.js
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
